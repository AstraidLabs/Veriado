<Window
    x:Class="Veriado.WinUI.Views.MainWindow"
    x:Name="WindowRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:contracts="using:Veriado.Contracts.Search"
    xmlns:conv="using:Veriado.WinUI.Converters"
    xmlns:winui="using:Microsoft.UI.Xaml.Controls"
    Title="Veriado">

    <Grid x:Name="LayoutRoot">
        <Grid.Resources>
            <conv:BooleanToVisibilityConverter x:Key="BoolToVisibility" />
            <conv:BooleanToVisibilityConverterEx x:Key="BoolToVisibilityEx" />
        </Grid.Resources>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState x:Name="Narrow">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="PreviewDetailPane.Visibility" Value="Collapsed" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="Wide">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1200" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="PreviewDetailPane.Visibility" Value="Visible" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding FiltersColumnWidth}" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="400" />
        </Grid.ColumnDefinitions>

        <Grid.KeyboardAccelerators>
            <KeyboardAccelerator Key="F" Modifiers="Control" Invoked="FocusSearch_Invoked" />
            <KeyboardAccelerator Key="M" Modifiers="Menu" Invoked="ToggleNavigation_Invoked" />
            <KeyboardAccelerator Key="Escape" Invoked="CloseNavigation_Invoked" />
            <KeyboardAccelerator Key="F5" Invoked="RefreshAccelerator_Invoked" />
            <KeyboardAccelerator Key="F6" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="F7" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="F8" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="Delete" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="F6" Modifiers="Shift" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="R" Modifiers="Control" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="Q" Modifiers="Control" Invoked="ForwardAccelerator_Invoked" />
            <KeyboardAccelerator Key="Tab" Invoked="ForwardAccelerator_Invoked" />
        </Grid.KeyboardAccelerators>

        <winui:CommandBar Grid.Row="0" Grid.ColumnSpan="3">
            <winui:AppBarButton Icon="Refresh"
                                Label="Obnovit"
                                Command="{Binding Files.RefreshCommand}" />
            <winui:AppBarSeparator />
            <winui:AppBarButton Icon="Find"
                                Label="Spotlight"
                                Command="{Binding Search.OpenCommand}" />
        </winui:CommandBar>

        <ContentControl x:Name="FiltersNavHost"
                         Grid.Row="1"
                         Grid.Column="0"
                         HorizontalAlignment="Stretch"
                         VerticalAlignment="Stretch"
                         Visibility="{Binding IsFiltersPaneVisible, Converter={StaticResource BoolToVisibility}}"
                         IsHitTestVisible="{Binding IsFiltersPaneVisible}" />

        <ContentPresenter Grid.Row="1"
                          Grid.Column="1"
                          Margin="12"
                          Content="{Binding CurrentContent}" />

        <Border x:Name="PreviewDetailPane"
                Grid.Row="1"
                Grid.Column="2"
                Margin="12"
                Padding="12"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
            <ContentPresenter Content="{Binding CurrentDetail}" />
        </Border>

        <Grid x:Name="StatusBar"
              Grid.Row="2"
              Grid.ColumnSpan="3"
              Background="{ThemeResource LayerOnAcrylicFillColorDefaultBrush}"
              Padding="8">
            <winui:InfoBar IsOpen="{Binding IsInfoBarOpen}"
                           Severity="{Binding HasError, Converter={StaticResource BoolToSeverityConverter}}"
                           Message="{Binding StatusMessage}" />
        </Grid>

        <Grid x:Name="NavigationOverlay"
              Grid.RowSpan="3"
              Grid.ColumnSpan="3"
              Background="{ThemeResource LayerOnAcrylicDefaultBrush}"
              Visibility="{Binding IsNavOpen, Converter={StaticResource BoolToVisibilityEx}}"
              IsHitTestVisible="{Binding IsNavOpen}"
              Tapped="NavigationOverlay_Tapped">
                <winui:NavigationView x:Name="OverlayNavView"
                                  Width="320"
                                  HorizontalAlignment="Left"
                                  VerticalAlignment="Stretch"
                                  IsSettingsVisible="True"
                                  PaneDisplayMode="LeftMinimal"
                                  IsPaneOpen="{Binding IsNavOpen, Mode=TwoWay}"
                                  SelectedItem="{Binding SelectedNavItem, Mode=TwoWay}">
                <winui:NavigationView.MenuItems>
                    <winui:NavigationViewItem Content="Správa souborů" Icon="Folder" Tag="Files" />
                    <winui:NavigationViewItem Content="Import souborů" Icon="Upload" Tag="Import" />
                    <winui:NavigationViewItem Content="Nastavení" Icon="Setting" Tag="Settings" />
                </winui:NavigationView.MenuItems>
            </winui:NavigationView>
        </Grid>

        <Grid x:Name="SearchOverlayRoot"
              Grid.RowSpan="3"
              Grid.ColumnSpan="3"
              Background="{ThemeResource LayerOnAcrylicFillColorDefaultBrush}"
              Visibility="{Binding Search.IsOpen, Converter={StaticResource BoolToVisibility}}"
              IsHitTestVisible="{Binding Search.IsOpen}"
              IsTabStop="True"
              KeyDown="SearchOverlayRoot_KeyDown">
            <Border MaxWidth="900"
                    Margin="100"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Top"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="12"
                    Padding="16">
                <Grid RowSpacing="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <AutoSuggestBox Grid.Column="0"
                                        PlaceholderText="Hledat..."
                                        QueryIcon="Find"
                                        Text="{Binding Search.QueryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        ItemsSource="{Binding Search.Suggestions}"
                                        TextChanged="SearchBox_TextChanged"
                                        QuerySubmitted="SearchBox_QuerySubmitted"
                                        SuggestionChosen="SearchBox_SuggestionChosen" />

                        <Button Grid.Column="1"
                                Content="Zavřít"
                                Command="{Binding Search.CloseCommand}" />
                    </Grid>

                    <Grid Grid.Row="1" ColumnSpacing="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <winui:ListView ItemsSource="{Binding Search.Results}"
                                        SelectionMode="None">
                            <winui:ListView.ItemTemplate>
                                <DataTemplate x:DataType="contracts:SearchHitDto">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding Snippet}" TextWrapping="Wrap" />
                                    </StackPanel>
                                </DataTemplate>
                            </winui:ListView.ItemTemplate>
                        </winui:ListView>

                        <StackPanel Grid.Column="1" Spacing="16">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Oblíbené" Style="{ThemeResource SubtitleTextBlockStyle}" />
                                <winui:ListView ItemsSource="{Binding Search.Favorites.Items}"
                                                SelectionMode="None"
                                                IsItemClickEnabled="True"
                                                ItemClick="FavoritesList_ItemClick">
                                    <winui:ListView.ItemTemplate>
                                        <DataTemplate x:DataType="contracts:SearchFavoriteItem">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding QueryText}" Style="{ThemeResource CaptionTextBlockStyle}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </winui:ListView.ItemTemplate>
                                </winui:ListView>
                            </StackPanel>

                            <StackPanel Spacing="8">
                                <TextBlock Text="Historie" Style="{ThemeResource SubtitleTextBlockStyle}" />
                                <winui:ListView ItemsSource="{Binding Search.History.Items}"
                                                SelectionMode="None"
                                                IsItemClickEnabled="True"
                                                ItemClick="HistoryList_ItemClick">
                                    <winui:ListView.ItemTemplate>
                                        <DataTemplate x:DataType="contracts:SearchHistoryEntry">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="{Binding QueryText}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding LastQueriedUtc}" Style="{ThemeResource CaptionTextBlockStyle}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </winui:ListView.ItemTemplate>
                                </winui:ListView>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

        </Grid>
    </Grid>
</Window>
