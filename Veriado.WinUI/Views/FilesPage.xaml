<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Veriado.WinUI.Views.FilesPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:animations="using:CommunityToolkit.WinUI.Animations"
    xmlns:behaviors="using:Microsoft.Xaml.Interactions.Core"
    xmlns:contracts="using:Veriado.Contracts.Files"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:toolkitControls="using:CommunityToolkit.WinUI.Controls"
    xmlns:viewModels="using:Veriado.WinUI.ViewModels"
    xmlns:winui="using:Microsoft.UI.Xaml.Controls"
    x:DataType="viewModels:FilesGridViewModel"
    Loaded="OnPageLoaded"
    Unloaded="OnPageUnloaded">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <animations:ImplicitAnimationSet x:Key="ItemEntranceAnimations">
            <animations:FadeIn Duration="0:0:0.3" />
            <animations:Offset Duration="0:0:0.3" From="0,24,0" To="0,0,0" />
        </animations:ImplicitAnimationSet>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Vertical" Spacing="12">
            <toolkitControls:RichSuggestBox
                x:Name="SearchBox"
                Width="560"
                ItemsSource="{x:Bind SearchSuggestions}"
                PlaceholderText="Vyhledat dokumenty"
                QueryIcon="Find"
                SuggestionChosen="OnSuggestionChosen"
                QuerySubmitted="OnQuerySubmitted"
                Text="{x:Bind QueryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                <toolkitControls:Segmented SelectedIndex="{x:Bind SearchModeIndex, Mode=TwoWay}">
                    <toolkitControls:SegmentedItem Content="Fulltext" />
                    <toolkitControls:SegmentedItem Content="Fuzzy" />
                </toolkitControls:Segmented>

                <toolkitControls:TokenizingTextBox
                    x:Name="TokenBox"
                    Width="420"
                    PlaceholderText="Filtry: mime:pdf author:smith validity:active"
                    ItemsSource="{x:Bind QueryTokens}" />

                <toolkitControls:RangeSelector
                    Width="280"
                    Header="Velikost (B)"
                    Minimum="0"
                    Maximum="104857600"
                    LowerValue="{x:Bind SizeLowerBound, Mode=TwoWay}"
                    UpperValue="{x:Bind SizeUpperBound, Mode=TwoWay}" />

                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <DatePicker Width="160" Date="{x:Bind CreatedFrom, Mode=TwoWay}" />
                    <DatePicker Width="160" Date="{x:Bind CreatedTo, Mode=TwoWay}" />
                </StackPanel>
            </StackPanel>
        </StackPanel>

        <ScrollViewer
            x:Name="RepeaterScrollViewer"
            Grid.Row="1"
            ViewChanged="OnScrollViewerViewChanged">
            <winui:ItemsRepeaterScrollHost>
                <ItemsRepeater
                    x:Name="FilesRepeater"
                    ItemsSource="{x:Bind Items, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <winui:UniformGridLayout
                            Orientation="Vertical"
                            ItemsStretch="Fill"
                            MinColumnSpacing="8"
                            MinRowSpacing="8"
                            MaximumRowsOrColumns="4" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="contracts:FileSummaryDto">
                            <Border
                                Padding="12"
                                Margin="0,0,0,8"
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                CornerRadius="8">
                                <StackPanel>
                                    <TextBlock Text="{x:Bind Name}" Style="{ThemeResource BodyStrongTextBlockStyle}" />
                                    <TextBlock Text="{x:Bind Author}" Opacity="0.8" />
                                    <TextBlock Text="{x:Bind Mime}" Opacity="0.7" />
                                    <TextBlock Text="{x:Bind Size, StringFormat='{}Velikost: {0:N0} B'}" />
                                </StackPanel>
                                <i:Interaction.Behaviors>
                                    <behaviors:EventTriggerBehavior EventName="Tapped">
                                        <behaviors:InvokeCommandAction Command="{x:Bind PageRoot.ViewModel.OpenDetailCommand}" CommandParameter="{x:Bind Id}" />
                                    </behaviors:EventTriggerBehavior>
                                </i:Interaction.Behaviors>
                                <animations:Implicit.ShowAnimations>
                                    <StaticResource ResourceKey="ItemEntranceAnimations" />
                                </animations:Implicit.ShowAnimations>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </winui:ItemsRepeaterScrollHost>
        </ScrollViewer>

        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
            <ProgressRing Width="28" Height="28" IsActive="{x:Bind IsBusy, Mode=OneWay}" />
            <Button Content="Obnovit" Command="{x:Bind RefreshCommand}" />
            <InfoBar
                IsOpen="{x:Bind IsInfoBarOpen, Mode=TwoWay}"
                Severity="{x:Bind HasError ? winui:InfoBarSeverity.Error : winui:InfoBarSeverity.Informational}"
                Title="Stav">
                <StackPanel>
                    <TextBlock Text="{x:Bind StatusMessage}" />
                    <TextBlock
                        Text="{x:Bind ErrorMessage}"
                        Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                        Visibility="{x:Bind !string.IsNullOrEmpty(ErrorMessage), Converter={StaticResource BoolToVisibilityConverter}}" />
                </StackPanel>
            </InfoBar>
        </StackPanel>
    </Grid>
</Page>
