<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Veriado.WinUI.Views.FilesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:animations="using:CommunityToolkit.WinUI.Animations"
    xmlns:behaviors="using:Microsoft.Xaml.Interactions.Core"
    xmlns:contracts="using:Veriado.Contracts.Files"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:toolkitControls="using:CommunityToolkit.WinUI.Controls"
    Loaded="OnPageLoaded">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <animations:ImplicitAnimationSet x:Key="ItemEntranceAnimations">
            <animations:FadeIn Duration="0:0:0.3" />
            <animations:Offset Duration="0:0:0.3" From="0,24,0" To="0,0,0" />
        </animations:ImplicitAnimationSet>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Orientation="Vertical" Spacing="12">
            <toolkitControls:RichSuggestBox
                x:Name="SearchBox"
                Width="560"
                ItemsSource="{Binding SearchSuggestions}"
                PlaceholderText="Vyhledat dokumenty"
                QueryIcon="Find"
                SuggestionChosen="OnSuggestionChosen"
                QuerySubmitted="OnQuerySubmitted"
                Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                <toolkitControls:Segmented SelectedIndex="{Binding SearchModeIndex, Mode=TwoWay}">
                    <toolkitControls:SegmentedItem Content="Fulltext" />
                    <toolkitControls:SegmentedItem Content="Fuzzy" />
                </toolkitControls:Segmented>

                <toolkitControls:TokenizingTextBox
                    x:Name="TokenBox"
                    Width="420"
                    PlaceholderText="Filtry: mime:pdf author:smith validity:active"
                    ItemsSource="{Binding QueryTokens}" />

                <toolkitControls:RangeSelector
                    x:Name="SizeRangeSelector"
                    Width="280"
                    Header="Velikost (B)"
                    Minimum="0"
                    Maximum="104857600"
                    LowerValue="{Binding SizeMinimum, Mode=TwoWay}"
                    UpperValue="{Binding SizeMaximum, Mode=TwoWay}" />

                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <DatePicker Width="160" Date="{Binding CreatedFrom, Mode=TwoWay}" />
                    <DatePicker Width="160" Date="{Binding CreatedTo, Mode=TwoWay}" />
                </StackPanel>
            </StackPanel>
        </StackPanel>

        <Grid Grid.Row="1" RowDefinitions="Auto,*" RowSpacing="12">
            <InfoBar
                IsOpen="True"
                Visibility="{Binding ShowInfoBar, Converter={StaticResource BoolToVisibilityConverter}}"
                Severity="Informational"
                Title="Stav"
                Message="{Binding StatusMessage}" />

            <GridView
                x:Name="FilesGrid"
                Grid.Row="1"
                ItemsSource="{Binding FilteredItems}"
                IsItemClickEnabled="True"
                SelectionMode="Single"
                SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                ItemClick="OnGridItemClick">
                <interactivity:Interaction.Behaviors>
                    <behaviors:EventTriggerBehavior EventName="ItemClick">
                        <behaviors:InvokeCommandAction Command="{Binding SelectFileCommand}" CommandParameter="{Binding SelectedItem, ElementName=FilesGrid}" />
                    </behaviors:EventTriggerBehavior>
                </interactivity:Interaction.Behaviors>

                <GridView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsWrapGrid x:Name="ItemsPanel" Orientation="Horizontal" MaximumRowsOrColumns="3" />
                    </ItemsPanelTemplate>
                </GridView.ItemsPanel>

                <GridView.ItemTemplate>
                    <DataTemplate x:DataType="contracts:FileSummaryDto">
                        <Grid Padding="12" Width="260" RowDefinitions="Auto,Auto,Auto" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8">
                            <StackPanel Spacing="4">
                                <TextBlock Text="{x:Bind Name}" FontSize="18" FontWeight="SemiBold" />
                                <TextBlock Text="{x:Bind Author}" Opacity="0.8" />
                                <TextBlock Text="{x:Bind Mime}" Opacity="0.7" />
                                <TextBlock Text="{x:Bind Size, StringFormat='{}Velikost: {0:N0} B'}" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </GridView.ItemTemplate>

                <animations:Implicit.ShowAnimations>
                    <StaticResource ResourceKey="ItemEntranceAnimations" />
                </animations:Implicit.ShowAnimations>
            </GridView>

            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="AdaptiveStates">
                    <VisualState x:Name="Wide">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="960" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Target="ItemsPanel.MaximumRowsOrColumns" Value="4" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Narrow">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="0" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Target="ItemsPanel.MaximumRowsOrColumns" Value="2" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
        </Grid>
    </Grid>
</Page>
