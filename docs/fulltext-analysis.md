# Analýza fulltextového vyhledávání

## Shrnutí architektury
- Indexování probíhá nad dvojicí úložišť: základ tvoří virtuální tabulky SQLite FTS5 `file_search` a `file_trgm`, které se udržují pomocí mapovacích tabulek `file_search_map` a `file_trgm_map` a tokenizeru `unicode61` bez diakritiky.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L28】
- `SqliteFts5Indexer` provádí operace v jediné transakci a před potvrzením volitelně spouští další akce (např. Lucene), zatímco `SqliteFts5Transactional` reálně zapisuje/maže řádky v obou FTS tabulkách a udržuje mapy rowid ↔︎ file_id.【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L1-L110】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L8-L163】
- Reálné spouštění indexace zajišťuje write/outbox worker, který načte `FileEntity`, promění jej na `SearchDocument` a předá `ISearchIndexer` (tj. hybridní kombinaci SQLite + Lucene).【F:Veriado.Infrastructure/Search/Outbox/OutboxWorker.cs†L203-L221】【F:Veriado.Domain/Files/FileEntity.cs†L361-L395】【F:Veriado.Infrastructure/Search/HybridSearchIndexer.cs†L1-L72】
- Vyhledávání kombinuje skóre z FTS5 a Lucene přes `HybridSearchQueryService`, který pro fuzzy vyhledávání využívá trigramy. Výsledky se slučují pomocí slovníku se zvýhodněním Lucene skóre 0,85×.【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L1-L204】

## Kritické problémy
1. **Do indexu se vůbec nedostává textový obsah souborů.** `SearchDocument` obsahuje pouze název, MIME a autora, které navíc `FileEntity.ToSearchDocument()` zaplňuje pouze metadaty (bez obsahu). `SqliteFts5Transactional` i `LuceneSearchIndexer` pracují výhradně s těmito poli, takže změna obsahu sice spustí reindex, ale skutečný text není uložen ani v FTS, ani v Lucene (`BuildCombinedText` skládá jen metadata). Výsledkem je „fulltext“, který ve skutečnosti vyhledává jen v názvu/MIME/autorovi.【F:Veriado.Domain/Search/SearchDocument.cs†L1-L12】【F:Veriado.Domain/Files/FileEntity.cs†L361-L395】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L59】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L140-L160】
2. **Generování snippetů odkazuje na neexistující sloupec.** FTS tabulka má tři sloupce (indexy 0–2), ale `SqliteFts5QueryService` volá `snippet(s, 3, …)`. To vrací prázdný text a v lepším případě jen zbytečně zatěžuje SQLite; v horším může vyvolat chybu při změně schématu. Je nutné buď přidat sloupec s obsahem, nebo snippet směřovat na existující sloupec (např. `title`).【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L8】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L137-L187】
3. **Sloučení výsledků může vracet méně položek, než uživatel očekává.** `HybridSearchQueryService` načítá z obou strojů jen `skip + take` záznamů. Jakmile se ve špičce výsledky výrazně překrývají (stejné dokumenty v Lucene i FTS), slovník po deduplikaci obsahuje méně položek než `take` a uživatel tak nikdy neuvidí záznamy, které by následovaly v individuálním pořadí jednoho z indexů. Je vhodné přidat bezpečnostní násobek (např. ×3) nebo iterativně dohledávat, dokud se nenaplní požadovaný počet unikátních výsledků.【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L19-L161】

## Doporučená vylepšení
- **Rozšířit `SearchDocument` a schéma FTS/Lucene o extrahovaný obsah.** Po přidání pole (např. `ContentText`) lze do FTS přidat čtvrtý sloupec a v Lucene indexovat celé tělo dokumentu; zároveň aktualizovat snippet tak, aby čerpal právě z tohoto pole.【F:Veriado.Domain/Search/SearchDocument.cs†L1-L12】【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L8】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L140-L160】
- **Optimalizovat práci s Lucene writerem.** Každý zápis otevírá nový `IndexWriter` a hned jej zavírá, což je pro větší objemy drahé; zvažte dlouhožijící instanci nebo background queue, která dávkuje změny.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L60-L113】
- **Zpřesnit trigram index.** `TrigramQueryBuilder.BuildIndexEntry` používá pouze titul a autora; pokud chcete fuzzy vyhledávání i podle názvu souboru nebo dalších metadat (např. systémových atributů), předejte do něj více polí a upravte mapování při indexaci.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L41-L58】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L49-L126】
- **Lépe monitorovat konzistenci indexu na startu.** `StartupIntegrityCheck` už umí ověřit/opravy spustit automaticky; doporučuji ve výchozím nastavení zapnout `RunIntegrityCheckOnStartup` a `RepairIntegrityAutomatically`, aby se chybějící nebo sirotčí záznamy opravily dřív, než ovlivní vyhledávání.【F:Veriado.Infrastructure/Integrity/StartupIntegrityCheck.cs†L1-L34】

