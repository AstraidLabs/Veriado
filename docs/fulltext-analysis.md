# Analýza fulltextového vyhledávání

## Architektura a tok dat
- **FTS5 vrstva.** Schéma SQLite vytváří virtuální tabulky `file_search` (title, mime, author, metadata_text, metadata) a `file_trgm` (trigramy) doplněné o mapovací tabulky pro převod `rowid` ↔︎ `file_id`. Tokenizer `unicode61` běží bez diakritiky a s prázdným `content`, takže aplikace kompletně řídí synchronizaci dat.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L26】
- **Pipeline indexace.** `FileEntity.ToSearchDocument()` promění doménový agregát na `SearchDocument`, který kromě serializovaného JSONu nese i předrenderovaný textový souhrn metadat. `SqliteFts5Transactional` zapisuje titul, autora, MIME, `metadata_text` i JSON a paralelně buduje trigramy; `LuceneSearchIndexer` vytváří zrcadlový dokument se stejnými poli. Vše probíhá v rámci transakce nebo asynchronní fronty dle konfigurace.【F:Veriado.Domain/Files/FileEntity.cs†L364-L389】【F:Veriado.Domain/Search/SearchDocument.cs†L1-L82】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L80】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L189】
- **Fuzzy vs. přesné dotazy.** Trigram index se nyní omezuje na human-readable pole (titul, autor, název souboru, metadata_text). Přesné FTS dotazy používají `bm25` s váhami titul 4.0, autor 2.0, metadata_text 0.8, metadata_json 0.2 a MIME 0.1. Lucene používá shodné posily a výsledky se slučují v `HybridSearchQueryService`, přičemž Lucene skóre je váženo 0,85×.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L1-L108】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L44-L305】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L189】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L1-L335】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L20-L219】

## Pokrytí indexovaných polí
- **FTS5 (přesné vyhledávání).** Do tabulky `file_search` se ukládá titul (`title`), MIME (`mime`), autor (`author`), předrenderovaný souhrn (`metadata_text`) a zpětně kompatibilní JSON (`metadata`). `metadata_text` slouží pro snippet i vážení, zatímco JSON se využívá pouze při fallbacku a pro zachování kompatibility se staršími indexy.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L70】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L170-L321】
- **Trigram (fuzzy vyhledávání).** Fuzzy index zahrnuje titul, autora, název souboru a `metadata_text`. Strojové JSON hodnoty se do trigramů nepromítají, čímž se dramaticky snižuje šum i velikost indexu.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L59-L70】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L108】
- **Lucene.Net.** Lucene dokument obsahuje titul, autora, `metadata_text`, JSON (pro nízkovážené dotazy a fallback) a časová razítka. Vyhledávání využívá `UnifiedHighlighter`, který preferuje titul/autora a až v případě potřeby generuje lidsky čitelné shrnutí z JSON.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L189】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L1-L335】

## Kritické nedostatky
1. **Kvalita `metadata_text` závisí na zdrojových datech.** Souhrn využívá dostupné vlastnosti (vlastník, atributy, velikost). Pokud metadata neobsahují překlad SID → jméno, zůstává strohé SID. Zvažujeme doplnění lokální cache SID → display name z adresářových služeb.
2. **Lucene a SQLite používají rozdílné highlightery.** Nový `UnifiedHighlighter` drží krok s FTS5, ale při extrémně dlouhých textech může fallbacknout na klasický highlighter, který vrací delší fragmenty. Další iterace by mohla zkrátit fragmenty podle typu pole.
3. **Sjednocení vážení v hybridním sloučení.** Váhy `bm25` i Lucene boosty jsou nyní sladěny, ale při budoucím rozšíření polí (např. o uživatelské tagy) bude nutné znovu sladit priority, aby Lucene fallback neupřednostňoval slabší signály.

## Doporučená vylepšení
- **Zpřesnit enriched metadata.** Současný souhrn zahrnuje velikost, vlastníka, atributy, ADS/Hlink. Do budoucna lze zvážit překlad SID → jméno uživatele nebo doplnění lokalizovaných názvů atributů.
- **Rozšířit zdroje pro `metadata_text`.** Pokud budou přibývat uživatelské tagy nebo klasifikace, vyplatí se přidat další lidsky čitelné části do souhrnu, aby uživatelé viděli kontext bez otevírání detailu.
- **Monitorovat dopad vážení.** V případě nových polí nebo změn v doméně je vhodné průběžně sledovat distribuci skóre a případně upravit váhy `bm25`/Lucene boostů, aby hybridní sloučení zachovalo preferenci titulů a autorů.
