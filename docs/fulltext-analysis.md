# Analýza fulltextového vyhledávání

## Architektura a tok dat
- **FTS5 vrstva.** Schéma SQLite vytváří virtuální tabulky `file_search` (title, mime, author, metadata_text, metadata) a `file_trgm` (trigramy) doplněné o mapovací tabulky pro převod `rowid` ↔︎ `file_id`. Tokenizer `unicode61` běží bez diakritiky a s prázdným `content`, takže aplikace kompletně řídí synchronizaci dat.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L30】
- **Pipeline indexace.** `FileEntity.ToSearchDocument()` promění doménový agregát na `SearchDocument`, který kromě serializovaného JSONu nese i předrenderovaný textový souhrn metadat. `SqliteFts5Transactional` zapisuje titul, autora, MIME, `metadata_text` i JSON a paralelně buduje trigramy; `LuceneSearchIndexer` vytváří zrcadlový dokument se stejnými poli. Vše probíhá v rámci transakce nebo asynchronní fronty dle konfigurace.【F:Veriado.Domain/Files/FileEntity.cs†L365-L396】【F:Veriado.Domain/Search/SearchDocument.cs†L11-L58】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L187】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L44-L192】
- **Hybridní koordinace.** Při zapnuté integraci Lucene se indexace provádí přes `HybridSearchIndexer`, který vždy zapisuje do SQLite a ještě před potvrzením transakce spouští Lucene operace; dotazy se spojují v `HybridSearchQueryService`, jenž nadvzorkuje oba zdroje a slučuje výsledky podle váženého skóre.【F:Veriado.Infrastructure/Search/HybridSearchIndexer.cs†L14-L72】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L15-L100】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L1-L315】
- **Fuzzy vs. přesné dotazy.** Trigram index se nyní omezuje na human-readable pole (titul, autor, název souboru, metadata_text). Přesné FTS dotazy používají `bm25` s váhami titul 4.0, autor 2.0, metadata_text 0.8, metadata_json 0.2 a MIME 0.1. Lucene používá shodné posily a výsledky se slučují v `HybridSearchQueryService`, přičemž Lucene skóre je váženo 0,85×.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L1-L156】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L23-L229】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L44-L192】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L1-L213】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L1-L315】

## Pokrytí indexovaných polí
- **FTS5 (přesné vyhledávání).** Do tabulky `file_search` se ukládá titul (`title`), MIME (`mime`), autor (`author`), předrenderovaný souhrn (`metadata_text`) a zpětně kompatibilní JSON (`metadata`). `metadata_text` slouží pro snippet i vážení, zatímco JSON se využívá pouze při fallbacku a pro zachování kompatibility se staršími indexy.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L70】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L170-L321】
- **Trigram (fuzzy vyhledávání).** Fuzzy index zahrnuje titul, autora, název souboru a `metadata_text`. Strojové JSON hodnoty se do trigramů nepromítají, čímž se dramaticky snižuje šum i velikost indexu.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L59-L70】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L108】
- **Lucene.Net.** Lucene dokument obsahuje titul, autora, `metadata_text`, JSON (pro nízkovážené dotazy a fallback) a časová razítka. Vyhledávání využívá `UnifiedHighlighter`, který preferuje titul/autora a až v případě potřeby generuje lidsky čitelné shrnutí z JSON.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L189】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L1-L335】

## Kritické nedostatky
1. **Lucene indexace probíhá před potvrzením SQLite transakce.** `HybridSearchIndexer` předává `beforeCommit` callback, který v rámci stále otevřené transakce spouští `LuceneSearchIndexer.IndexAsync/DeleteAsync`. Pokud následné `CommitAsync` na SQLite selže (např. kvůli I/O chybě), Lucene update už proběhl a může být v mezičase i commitnut, což vede k trvalé divergenci mezi FTS a Lucene indexem.【F:Veriado.Infrastructure/Search/HybridSearchIndexer.cs†L49-L71】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L33-L90】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L138】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L44-L192】
   - **Doporučená oprava:** Přesunout volání Lucene indexeru až po úspěšném potvrzení SQLite transakce (např. do `finally` bloku po `CommitAsync`), nebo zavést kompenzační logiku, která při chybě commitnutí Lucene změny revertuje / naplánuje plnou reindexaci daného souboru.
2. **Kvalita `metadata_text` závisí na zdrojových datech.** Souhrn využívá dostupné vlastnosti (vlastník, atributy, velikost). Pokud metadata neobsahují překlad SID → jméno, zůstává strohé SID. Zvažujeme doplnění lokální cache SID → display name z adresářových služeb.【F:Veriado.Domain/Search/MetadataTextFormatter.cs†L12-L104】
3. **Rozdílné highlightery SQLite vs. Lucene.** Nový `UnifiedHighlighter` drží krok s FTS5, ale při extrémně dlouhých textech může fallbacknout na klasický highlighter, který vrací delší fragmenty. Další iterace by mohla zkrátit fragmenty podle typu pole.【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L200-L335】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L148-L229】
4. **Fuzzy výsledky nejsou deterministicky seřazené.** FTS5 dotaz nad `file_trgm` se řadí pouze podle `bm25(t)`, takže při shodném skóre (časté u krátkých dotazů) se pořadí mění podle vnitřní heuristiky a stránkování je nestabilní.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L76-L145】

## Doporučená vylepšení
- **Změna koordinace s Lucene.** Po přesunu Lucene operací až za `CommitAsync` přidejte telemetry a případné retry s exponenciálním zpožděním. Alternativou je při pádu transakce zařadit příslušný `file_id` do outboxu pro reindexaci, aby se divergence automaticky opravila.【F:Veriado.Infrastructure/Search/HybridSearchIndexer.cs†L49-L71】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L33-L90】
- **Deterministické řazení fuzzy výsledků.** Doplnění `ORDER BY bm25(t) ASC, m.rowid` (nebo `file_id`) stabilizuje pořadí stránek a sjednotí výsledky s deterministickým slučováním v aplikační vrstvě.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L76-L145】
- **Omezení velikosti trigram indexu.** `TrigramQueryBuilder.BuildIndexEntry` agreguje všechny trigramy ze všech polí, což může u velmi dlouhých názvů/metadata vytvořit desítky tisíc tokenů. Zvažte limit na počet trigramů na dokument nebo normalizaci (např. sekat `metadata_text` na N znaků) před uložením do FTS, aby se zpomalující dokumenty nedostaly do indexu.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L24-L126】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L48-L69】
- **Zpřesnit enriched metadata.** Současný souhrn zahrnuje velikost, vlastníka, atributy, ADS/Hlink. Do budoucna lze zvážit překlad SID → jméno uživatele nebo doplnění lokalizovaných názvů atributů.【F:Veriado.Domain/Search/MetadataTextFormatter.cs†L12-L104】
- **Rozšířit zdroje pro `metadata_text`.** Pokud budou přibývat uživatelské tagy nebo klasifikace, vyplatí se přidat další lidsky čitelné části do souhrnu, aby uživatelé viděli kontext bez otevírání detailu.【F:Veriado.Domain/Search/SearchDocument.cs†L11-L58】
- **Monitorovat dopad vážení.** V případě nových polí nebo změn v doméně je vhodné průběžně sledovat distribuci skóre a případně upravit váhy `bm25`/Lucene boostů, aby hybridní sloučení zachovalo preferenci titulů a autorů.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L23-L229】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L22-L213】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L1-L315】
