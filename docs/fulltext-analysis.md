# Analýza fulltextového vyhledávání

## Architektura a tok dat
- **FTS5 vrstva.** Schéma SQLite vytváří dvojici virtuálních tabulek `file_search` (title, mime, author) a `file_trgm` (trigramy) doplněných o mapovací tabulky pro převod `rowid` ↔︎ `file_id`. Tokenizer `unicode61` běží bez diakritiky a s prázdným `content`, takže aplikace kompletně řídí synchronizaci dat.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L24】
- **Pipeline indexace.** `FileEntity.ToSearchDocument()` promění doménový agregát na `SearchDocument` se základními poli (název, MIME, autor, název souboru, časová razítka). `SqliteFts5Indexer` spustí transakci a deleguje konkrétní INSERT/DELETE na `SqliteFts5Transactional`, který zapisuje data do FTS tabulek a trigram indexu.【F:Veriado.Domain/Files/FileEntity.cs†L364-L380】【F:Veriado.Domain/Search/SearchDocument.cs†L1-L12】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L15-L87】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L18-L74】
- **Fuzzy vs. přesné dotazy.** Trigram index se buduje pomocí `TrigramQueryBuilder.BuildIndexEntry`, jenž generuje množinu trigramů z názvu, autora, názvu souboru a MIME typu. Přesné FTS dotazy používají `bm25` se silnou vahou na názvu, menší na MIME a autorovi. Lucene replikuje stejná pole a výsledky se slučují v `HybridSearchQueryService` s vyšší vahou pro SQLite, resp. 0,85× pro Lucene.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L41-L58】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L49-L108】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L44-L190】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L162】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L20-L219】

## Pokrytí indexovaných polí
- **FTS5 (přesné vyhledávání).** Do tabulky `file_search` se ukládá pouze titul (`title`), MIME (`mime`) a autor (`author`). Klíčová metadata jako atributy souboru, vlastní tagy nebo popisy zde chybí, takže přesné vyhledávání mimo tato tři pole není možné.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L26-L50】
- **Trigram (fuzzy vyhledávání).** Fuzzy index zahrnuje titul, autora, název souboru i MIME. Ani zde se ale neobjevují systémová nebo uživatelská metadata, takže výsledky fuzzy hledání nejsou schopny reagovat na tyto hodnoty.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L41-L58】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L49-L108】
- **Lucene.Net.** Lucene dokument obsahuje stejné tři textové kolony (title, author, mime) plus časová razítka. Žádná další metadata ani obsah souboru se neindexují.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L162】

## Kritické nedostatky
1. **Metadata nejsou fulltextově dostupná.** Ačkoli doména spravuje systémová metadata (`FileSystemMetadata`), `SearchDocument` je nepřenáší a indexery je nikam nezapisují. Uživatel tak nemůže vyhledávat podle vlastníka, atributů, počtu hardlinků ani jiných metadat, přestože změny těchto polí vyvolávají reindexaci. Doporučení: rozšířit `SearchDocument` a schéma FTS/Lucene o serializovaná metadata (např. další sloupce nebo JSON, popř. specializované tabulky) a aktualizovat dotazy, aby bylo možné filtrovat i podle nich.【F:Veriado.Domain/Search/SearchDocument.cs†L1-L12】【F:Veriado.Domain/Files/FileEntity.cs†L364-L380】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L26-L58】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L162】
2. **Lucene vrací autora jako snippet.** `SearchHit` očekává ve čtvrtém parametru úryvek, ale `LuceneSearchQueryService.SearchAsync()` předává místo snippetů hodnotu autora. Front-end tak zobrazuje autora v poli pro náhled textu a uživatel nikdy neuvidí zvýrazněný úryvek z Lucene. Oprava: doplnit generování skutečného snippetu (např. pomocí `UnifiedHighlighter`) nebo alespoň předávat `null`, dokud highlight nepřibude.【F:Veriado.Domain/Search/SearchHit.cs†L1-L10】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L91-L138】
3. **Zvýraznění z FTS pokrývá jen titul.** Dotaz `highlight(s, 0, …)` a `snippet(s, 0, …)` vrací zvýraznění pouze z prvního sloupce (title). Pokud uživatel hledá podle MIME či autora, výsledky se sice vrátí, ale bez zvýraznění – uživatel nepozná, proč dokument odpovídá dotazu. Doporučení: doplnit highlight pro všechny relevantní sloupce (např. kombinací více `highlight`/`snippet` volání) a zobrazovat kontext odpovídající shodě.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L137-L195】

## Doporučená vylepšení
- **Rozšířit indexy o obsah a metadata.** Zvážit přidání textového obsahu souboru a serializovaných metadat do FTS5 (další sloupec) i Lucene. Umožní to skutečné fulltextové vyhledávání nad obsahem dokumentů a filtrování podle systémových atributů.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L8】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L162】
- **Vyvážit váhy `bm25`.** Aktuální 4:2:1 upřednostňuje MIME před autorem, což může produkovat nerelevantní pořadí u dotazů s běžnými MIME typy. Zvážit snížení váhy MIME nebo přesun do trigram indexu, aby MIME sloužilo spíš jako filtr než primární fulltextový signál.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L44-L167】
- **Optimalizovat Lucene pipeline.** Každý zápis otevírá/zavírá `IndexWriter`, což je u větších dávek nákladné. Zvažte dlouhožijící writer s `BackgroundService` frontou nebo sdílený writer v `HybridSearchIndexer`, aby se snížily IO náklady při masivním reindexu.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L118】
- **Rozšířit trigram index o metadata.** Pokud mají metadata zůstat jen pro fuzzy hledání, předejte je jako další argumenty `BuildIndexEntry`, aby bylo možné alespoň částečně vyhledávat vlastní tagy či uživatelská pole bez přesného match dotazu.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L41-L58】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L49-L108】
