# Analýza fulltextového vyhledávání

## Architektura a tok dat
- **FTS5 vrstva.** Schéma SQLite vytváří virtuální tabulky `file_search` (title, mime, author, metadata) a `file_trgm` (trigramy) doplněné o mapovací tabulky pro převod `rowid` ↔︎ `file_id`. Tokenizer `unicode61` běží bez diakritiky a s prázdným `content`, takže aplikace kompletně řídí synchronizaci dat.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L26】
- **Pipeline indexace.** `FileEntity.ToSearchDocument()` promění doménový agregát na `SearchDocument`, který obsahuje i serializovaná metadata (název, MIME, autor, názvy souboru, systémová metadata). `SqliteFts5Indexer` spustí transakci a deleguje konkrétní INSERT/DELETE na `SqliteFts5Transactional`, který zapisuje data do FTS tabulek a trigram indexu, zatímco Lucene indexer vytváří zrcadlový dokument s totožnými poli.【F:Veriado.Domain/Files/FileEntity.cs†L364-L389】【F:Veriado.Domain/Search/SearchDocument.cs†L1-L71】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L15-L87】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L80】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L172】
- **Fuzzy vs. přesné dotazy.** Trigram index se buduje pomocí `TrigramQueryBuilder.BuildIndexEntry`, jenž generuje množinu trigramů z názvu, autora, názvu souboru, MIME typu i serializovaných metadat. Přesné FTS dotazy používají `bm25` se silnou vahou na názvu, menší na autorovi a metadatech, nejnižší na MIME. Lucene replikuje stejná pole a výsledky se slučují v `HybridSearchQueryService` s vyšší vahou pro SQLite, resp. 0,85× pro Lucene.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L71】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L1-L108】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L44-L209】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L183】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L20-L219】

## Pokrytí indexovaných polí
- **FTS5 (přesné vyhledávání).** Do tabulky `file_search` se ukládá titul (`title`), MIME (`mime`), autor (`author`) a JSON serializovaná metadata (`metadata`). Díky tomu lze přes FTS dohledat i hodnoty jako vlastník, atributy nebo velikost, nicméně uživatel dostává pouze necitlivý JSON úryvek bez sémantiky (viz nedostatky níže).【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L57】【F:Veriado.Domain/Search/SearchDocument.cs†L1-L71】
- **Trigram (fuzzy vyhledávání).** Fuzzy index zahrnuje titul, autora, název souboru, MIME i serializovaná metadata. Normalizace trigramů z JSON však dramaticky rozšiřuje tokeny (např. klíče `alternateDataStreamCount`), což navyšuje index i šum při hledání.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L58-L71】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L108】
- **Lucene.Net.** Lucene dokument obsahuje titul, MIME, autora, metadata JSON a časová razítka. Lucene dotazy využívají highlightery, takže uživatel dostane úryvky ze stejného JSON jako u SQLite, pokud není k dispozici textovější pole.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L183】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L61-L151】

## Kritické nedostatky
1. **Metadata jsou serializována do plochého JSONu bez mapování na konkrétní pole.** Vyhledávání vrací zvýrazněné úryvky typu `"owner":"S-1-5-21…"`, což je pro uživatele obtížně čitelné. Zároveň JSON klíče i strukturální znaky zbytečně zvyšují váhu metadat v `bm25` a trigram indexu. Doporučení: rozdělit metadata do specializovaných sloupců/fieldů (např. `owner`, `attributes`, `tags`) nebo alespoň ukládat uživatelsky přívětivou textovou reprezentaci (např. předrenderovanou větu).【F:Veriado.Domain/Search/SearchDocument.cs†L1-L71】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L71】【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L183】
2. **Váhy `bm25` neodrážejí informační hodnotu polí.** MIME má sice nejnižší váhu, metadata ale získávají hodnotu 1.0, i když jde převážně o strojově generovaný JSON. To může posouvat dokumenty s totožným názvem, ale jinými atributy, na vrchol žebříčku. Doporučení: upravit váhy tak, aby metadata fungovala jako sekundární signál (např. 0.2) a autor měl větší vliv na relevantní dotazy.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L44-L182】
3. **Trigram index ukládá celé serializované metadata.** Normalizace odstraní diakritiku, ale zanechá dlouhé řetězce (např. `alternatedatastreamcount`), což zvyšuje velikost indexu a rozplývá fuzzy shodu. Doporučení: generovat trigramy jen z human-readably polí (název, autor, název souboru) a pro metadata použít specializované dotazy nebo omezenou sadu hodnot (např. jen vlastní tagy).【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L58-L71】【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L108】
4. **Výsledky FTS zvýrazňují JSON místo uživatelských textů.** `SqliteFts5QueryService.SelectSnippet` vrací první neprázdný snippet, typicky právě z metadatového JSONu. Bez post-processingu pak UI zobrazuje `"attributes":"ReadOnly,Archive"`, což nepomáhá pochopit relevanci. Doporučení: post-processovat JSON do přirozeného textu, případně preferovat zvýraznění z titulů/autora a metadatový snippet zobrazovat jen ve vedlejším panelu.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L137-L209】

## Doporučená vylepšení
- **Normalizovat metadata pro vyhledávání.** Přidat per-field sloupce (např. `owner`, `attributes`, `size_range`) nebo materializované vyhledávací fráze a JSON ponechat jen jako zdroj pro detail. Zlepší to jak přesnost FTS, tak highlighty.【F:Veriado.Domain/Search/SearchDocument.cs†L1-L71】【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L26】
- **Omezit metadatový vstup do trigram indexu.** `TrigramQueryBuilder.BuildIndexEntry` by měl ignorovat strojová pole a soustředit se na přirozený text. Lze např. předat pouze titul, autora a název souboru, případně vlastnoruční tagy.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L108】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L58-L71】
- **Převést highlighty do čitelné podoby.** Před návratem z query služeb deserializovat `metadataJson` a vytvořit krátké popisky (`Vlastník: …`, `Atributy: …`). Stejný postup lze využít i pro Lucene highlighty, aby obě větve vracely konzistentní výstup.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L137-L209】【F:Veriado.Infrastructure/Search/LuceneSearchQueryService.cs†L97-L151】
- **Zvážit indexaci obsahu.** Pokud aplikace pracuje s textovými soubory, doplnění obsahu jako samostatného pole (s nízkou vahou) by významně zvýšilo hodnotu fulltextu. Je vhodné řešit mimo SQLite (kvůli velikosti) – Lucene či externí vyhledávač.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L129-L183】
- **Optimalizovat Lucene zápisy.** I nadále platí, že každý zápis otevírá/zavírá `IndexWriter`. Přidání dlouhožijícího writeru nebo asynchronní fronty sníží IO náklady při masivních reindexacích.【F:Veriado.Infrastructure/Search/LuceneSearchIndexer.cs†L40-L127】
