# FTS5 content-linked analýza

## Přehled komponent
| Oblast | Soubor | Třídy/Metody | Účel |
| --- | --- | --- | --- |
| Doména | Veriado.Domain/Search/SearchIndexState.cs | `SearchIndexState`, `ApplyIndexed`, `MarkStale` | Drží stav indexace na entitě souboru včetně posledních hashů obsahu a analyzéru.【F:Veriado.Domain/Search/SearchIndexState.cs†L1-L129】 |
| Doména | Veriado.Domain/Files/FileEntity.cs | `ToSearchDocument`, `ConfirmIndexed`, `MarkSearchDirty` | Převádí soubor na indexovací dokument a synchronizuje příznaky stárnutí v reakci na změny obsahu či metadat.【F:Veriado.Domain/Files/FileEntity.cs†L365-L451】 |
| Aplikace | Veriado.Application/UseCases/Search/SearchFilesHandler.cs | `Handle`, `BuildQueryExpression`, `NormalizeWildcardSegment` | Parsuje textové dotazy, skládá boolovský strom a generuje `SearchQueryPlan` pro FTS dotaz.【F:Veriado.Application/UseCases/Search/SearchFilesHandler.cs†L14-L604】 |
| Aplikace | Veriado.Application/Search/SearchQueryBuilder.cs | `Build`, `Range`, `FormatToken` | Sestavuje MATCH výraz, aplikuje rozsahové filtry a připravuje BM25 váhy pro dotaz.【F:Veriado.Application/Search/SearchQueryBuilder.cs†L29-L520】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteFts5Transactional.cs | `IndexAsync`, `DeleteAsync` | Transakčně upsertuje řádky v `DocumentContent` a tím spouští FTS triggery; zároveň vede write-ahead žurnál.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L23-L154】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteFts5QueryService.cs | `SearchAsync`, `BuildScoreQuery`, `BuildHitQuery` | Vykonává MATCH dotazy, počítá BM25, mapuje snippety a telemetryzuje latence.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L1-L420】 |
| Infrastruktura | Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs | `Compute`, `GetAnalyzerVersion` | Určuje podpis analyzéru a normalizovaný titul pro detekci driftu indexu.【F:Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs†L12-L90】 |
| Infrastruktura | Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs | `NeedsReindexAsync` | Porovnává uložené hashe se stavem agregátu a rozhoduje o reindexaci.【F:Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs†L1-L24】 |
| Integrita | Veriado.Infrastructure/Integrity/IndexAuditor.cs | `VerifyAsync`, `RepairDriftAsync` | Porovnává doménu s `DocumentContent` a plánuje opravné dávky; běží i na pozadí.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L1-L212】 |
| Integrita | Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs | `RecreateFulltextSchemaAsync`, `RepairAsync` | Spravuje rebuild FTS schématu, WAL checkpointy a vyvolává `INSERT … VALUES('rebuild')`.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L300-L456】 |
| DI & konfigurace | Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs | `AddInfrastructureInternal` | Registruje FTS indexer, query service, write-ahead žurnál a telemetrii v DI kontejneru.【F:Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs†L56-L150】 |

## Stav FTS5 schématu
- **Content-linked tabulka.** `DocumentContent` ukládá normalizované pole a FTS tabulka `file_search` je na ni navázána přes `content_rowid='DocId'`; triggery `dc_ai/dc_au/dc_ad` zajišťují synchronizaci po INSERT/UPDATE/DELETE.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L3-L39】
- **Transakční zápis.** `SqliteFts5Transactional.IndexAsync` provádí `INSERT … ON CONFLICT` do `DocumentContent` a po úspěchu čistí write-ahead žurnál, takže FTS i content tabulka zůstávají konzistentní v jedné transakci.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L23-L88】
- **Dotazování a řazení.** `SqliteFts5QueryService` skládá dotaz s `bm25(file_search, …)` podle váh z `SearchScorePlan`, vrací snippety přes `snippet()` a řadí podle skóre, času a titulku pro determinismus.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L335-L420】
- **Infrastruktura & DI.** `ServiceCollectionExtensions` nastavuje SQLite připojení, detekuje podporu FTS, registruje indexer, query service, write-ahead servis i periodický auditor.【F:Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs†L56-L150】

## Identifikované nedostatky (aktuální stav)
1. `SearchIndexSignatureCalculator` vrací `tokenHash: null`, ačkoli `SearchIndexState` hodnotu očekává, takže změny ve skutečném tokenizačním výstupu analyzéru nejsou detekovány hashováním tokenů.【F:Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs†L22-L28】【F:Veriado.Domain/Search/SearchIndexState.cs†L71-L127】
2. `NeedsReindexEvaluator` porovnává pouze hash obsahu, normalizovaný titulek, verzi analyzéru a token hash – změny v `MetadataText` nebo `Metadata` detekuje jen tehdy, pokud se stihnou vyvolat doménové události, což znesnadňuje odhalení driftu po úpravách serializace metadat.【F:Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs†L12-L24】
3. Schéma `DocumentContent` neobsahuje sloupec pro samotný text dokumentu a `FileEntity.ToSearchDocument` posílá pouze shrnutí metadat. Vyhledávání je proto omezeno na titulky, autora, MIME a metadata, nikoli na plný obsah souboru.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L3-L22】【F:Veriado.Domain/Files/FileEntity.cs†L365-L396】
4. `IndexAuditor` pro snapshot indexu načítá pouze GUIDy z `DocumentContent`; stav skutečné tabulky `file_search` neověřuje, takže případný drift mezi content tabulkou a FTS (např. po ručním zásahu) zůstane neodhalen.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L170-L200】
5. `IndexAuditor.RepairDriftAsync` ignoruje seznam `Extra`, takže sirotčí řádky v `DocumentContent` nejsou mazány ani jinak řešeny a mohou dál růst.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L109-L141】
6. `SuggestionMaintenanceService` používá jednoduchou ASCII tokenizaci a napevno nastavuje jazyk na `"en"`, čímž obchází nakonfigurované analyzéry a znevýhodňuje vícejazyčné instalace.【F:Veriado.Infrastructure/Search/SuggestionMaintenanceService.cs†L24-L76】
7. `FulltextIntegrityService` při údržbě spouští pouze kompletní rebuild (`INSERT … VALUES('rebuild')`), ale nenabízí `optimize`, `merge=N` ani `integrity-check`, což omezuje možnosti průběžné defragmentace indexu.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L366-L456】
8. `SqlitePragmaHelper.ApplyAsync` striktně prosazuje `PRAGMA synchronous=NORMAL` bez možnosti dočasného přepnutí na `OFF` během hromadných rebuildů, jak doporučuje FTS5 dokumentace pro dosažení vyšší propustnosti.【F:Veriado.Infrastructure/Persistence/SqlitePragmaHelper.cs†L10-L39】
9. Podpis indexu nezohledňuje per-souborové `FtsPolicy` – informace se ukládá v doménové entitě, ale `SearchIndexSignatureCalculator.Compute` ji do podpisu ani hashů nezahrnuje, takže změna tokenizační politiky na souboru nevyvolá reindex.【F:Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs†L22-L28】【F:Veriado.Domain/Files/FileEntity.cs†L45-L121】
10. Při normalizaci wildcard segmentů dochází ke sloučení více tokenů bez oddělovače (`string.Concat`), což z dotazu jako `"data science*"` udělá `datascience*` a snižuje šanci na zásah, pokud je ve zdroji mezera.【F:Veriado.Application/UseCases/Search/SearchFilesHandler.cs†L554-L604】
