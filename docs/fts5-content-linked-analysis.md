# FTS5 content-linked refactor – analýza

## Přehled komponent
| Oblast | Soubor | Třídy/Metody | Účel |
| --- | --- | --- | --- |
| Doména | Veriado.Domain/Search/SearchIndexState.cs | `SearchIndexState`, `ApplyIndexed`, `MarkStale` | Uchovává stav indexace na entitě souboru včetně podpisu analyzéru a hashů obsahu.【F:Veriado.Domain/Search/SearchIndexState.cs†L6-L104】 |
| Doména | Veriado.Domain/Files/FileEntity.cs | `MarkSearchDirty`, `ConfirmIndexed`, události `SearchReindexRequested` | Spravuje signalizaci reindexace při změnách obsahu, metadat i verzí schématu.【F:Veriado.Domain/Files/FileEntity.cs†L140-L516】 |
| Aplikace | Veriado.Application/Search/SearchQueryPlan.cs | `SearchQueryPlanFactory.FromMatch`, `SearchScorePlan` | Popisuje plán FTS dotazu včetně BM25 vah a dalších filtrů.【F:Veriado.Application/Search/SearchQueryPlan.cs†L1-L86】 |
| Aplikace | Veriado.Application/UseCases/Search/SearchFilesHandler.cs | `Handle`, `BuildQueryExpression` | Překládá text dotazu na `SearchQueryPlan` a spouští vyhledávání přes službu FTS.【F:Veriado.Application/UseCases/Search/SearchFilesHandler.cs†L14-L211】 |
| Aplikace | Veriado.Application/UseCases/Queries/FileGrid/FileGridQueryHandler.cs | `Handle` | Vytváří stránkované výsledky pro mřížku souborů s využitím FTS dotazu a řazení podle relevance.【F:Veriado.Application/UseCases/Queries/FileGrid/FileGridQueryHandler.cs†L13-L146】 |
| Aplikace | Veriado.Application/Search/SearchQueryBuilder.cs | `Term`, `Phrase`, `Build` | Staví FTS MATCH výraz se syntaktickými operátory, prefixy a rozsahy.【F:Veriado.Application/Search/SearchQueryBuilder.cs†L1-L240】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteFts5Transactional.cs | `IndexAsync`, `DeleteAsync` | Provádí transakční upserty do `DocumentContent` a spouští write-ahead logiku pro FTS operace.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L1-L154】 |
| Infrastruktura | Veriado.Infrastructure/Concurrency/WriteWorker.cs | `ProcessBatchAttemptAsync`, `ApplyFulltextUpdatesAsync` | Řídí dávkové zpracování zápisů, orchestruje indexaci a rollback při chybách FTS.【F:Veriado.Infrastructure/Concurrency/WriteWorker.cs†L182-L558】 |
| Infrastruktura | Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs | `Compute`, `GetAnalyzerVersion` | Vypočítává podpis analyzéru a normalizované titulky pro detekci zastaralých záznamů.【F:Veriado.Infrastructure/Search/SearchIndexSignatureCalculator.cs†L12-L74】 |
| Infrastruktura | Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs | `NeedsReindexAsync` | Porovnává uložené hashe s aktuálním stavem a rozhoduje o reindexaci.【F:Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs†L1-L26】 |
| Infrastruktura | Veriado.Infrastructure/Search/FtsWriteAheadService.cs | `LogAsync`, `ReplayPendingAsync`, `RetryOnceAsync` | Zajišťuje write-ahead žurnál FTS operací, přehrávání a dead-letter frontu.【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L1-L240】【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L300-L536】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteFts5Indexer.cs | `IndexAsync`, `DeleteAsync` | Externí indexer spouštěný mimo hlavní transakci pro asynchronní zápisy.【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L1-L122】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteSearchIndexCoordinator.cs | `IndexAsync` | Napojení doménové entity na FTS index v rámci probíhající SQLite transakce.【F:Veriado.Infrastructure/Search/SqliteSearchIndexCoordinator.cs†L1-L57】 |
| Infrastruktura | Veriado.Infrastructure/Search/SqliteFts5QueryService.cs | `SearchAsync`, `BuildHitQuery`, `MapHit` | Provádí FTS dotazy s BM25, vrací zvýrazněné výsledky a telemetrii latence.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L1-L336】 |
| Integrita | Veriado.Infrastructure/Integrity/IndexAuditor.cs | `VerifyAsync`, `RepairDriftAsync` | Porovnává `DocumentContent` s doménovými daty a plánuje reindexaci chybějících souborů.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L1-L212】 |
| Integrita | Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs | `VerifyAsync`, `RepairAsync`, `RecreateFulltextSchemaAsync` | Diagnostika a oprava FTS schématu, řízené rebuildy a měření konzistence.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L60-L430】 |
| DI & konfigurace | Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs | `AddInfrastructureInternal` | Registrace FTS služeb, auditoru a background workerů v DI kontejneru.【F:Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs†L56-L214】 |
| DI & konfigurace | Veriado.Infrastructure/Persistence/Options/InfrastructureOptions.cs | `IndexAuditInterval`, `BatchSize` | Konfigurační parametry pro FTS, dávky a interval auditů.【F:Veriado.Infrastructure/Persistence/Options/InfrastructureOptions.cs†L5-L58】 |
| SQL | Veriado.Infrastructure/Persistence/Schema/Fts5.sql | definice `DocumentContent`, `file_search`, triggery | Deklaruje content-linked FTS tabulku, triggery a write-ahead tabulky.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L36】 |
| SQL | Veriado.Infrastructure/Migrations/20251015090000_Fts5ContentLinked.cs | `Up`, `Down` | Migrace převádějící index na content-linked režim a rebuild z `DocumentContent`.【F:Veriado.Infrastructure/Migrations/20251015090000_Fts5ContentLinked.cs†L6-L121】 |
| Diagnostika | Veriado.Contracts/Diagnostics/IndexStatisticsDto.cs | `IndexStatisticsDto` | DTO pro základní metriky FTS indexu využívané v diagnostice.【F:Veriado.Contracts/Diagnostics/IndexStatisticsDto.cs†L1-L11】 |

## Identifikované nedostatky (původní stav)
1. FTS tabulka používala prázdný `content=''` a vyžadovala mapovací tabulku `file_search_map`, což zvyšovalo riziko driftu a složitost rebuildů.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L18】
2. Neexistovaly triggery pro synchronizaci s doménovými daty – každá operace musela ručně mazat a vkládat do FTS, což prodlužovalo zápisy.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L120】
3. Chyběla centrální tabulka s normalizovanými poli (`DocumentContent`), takže nebylo možné využít `INSERT … VALUES('rebuild')` k rychlému přepočtu indexu.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L18】
4. `SqliteFts5Transactional` prováděl sekvenční příkazy bez připraveného `ON CONFLICT` upsertu, což vytvářelo zbytečné I/O i při idempotentních dávkách.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L32-L120】
5. `SqliteFts5QueryService` spoléhal na join přes mapovací tabulku a nevyužíval obsahovou tabulku, což prodlužovalo dotazy a komplikovalo rebuildy.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L360-L420】
6. Index auditor běžel jen na explicitní volání; chyběl periodický background worker, který by pravidelně vyhodnocoval drift a plánoval reindexaci.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L1-L212】
7. `InfrastructureOptions` neobsahoval interval pro automatické audity, takže cadence bylo nutné řešit manuálně.【F:Veriado.Infrastructure/Persistence/Options/InfrastructureOptions.cs†L5-L47】
8. `SqlitePragmaHelper` nastavoval pouze 128 MB pro `mmap_size` a neaplikoval `page_size=4096`, což omezovalo propustnost při rozsáhlých dávkách.【F:Veriado.Infrastructure/Persistence/SqlitePragmaHelper.cs†L9-L90】
9. Integritní služba při rebuildu netriggerovala `INSERT INTO file_search(file_search) VALUES('rebuild')`, takže nové schéma zůstávalo prázdné do doby ruční reindexace.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L360-L426】
10. Dotazovací služba počítala váhy BM25 ve starém pořadí sloupců (title, mime, author…), což neodpovídalo budoucímu content-linked pořadí a zhoršovalo relevanci titulku vs. autora.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L330-L380】
11. Integritní skripty mazaly `file_search_map`, ale neřešily navázaná data, takže docházelo k sirotkům při přerušení rebuildu.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L360-L420】
12. Nebyl k dispozici skript pro měření propustnosti indexace a latence dotazů, což komplikovalo regresní testy výkonu po úpravách FTS.【F:tools/fts5-benchmark.csx†L1-L167】
13. Dokumentace stále popisovala mapovací tabulku `file_search_map`, což odporovalo cílové architektuře a mátlo čtenáře.【F:docs/fulltext-analysis.md†L1-L120】【F:docs/search-indexing-analysis.md†L1-L80】
14. Index auditor načítal GUIDy přímo z mapovací tabulky, což znemožňovalo jednoduchou detekci driftu při přechodu na content-linked FTS.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L120-L212】
15. Reindexační pipeline nepodporovala atomické dávkové mazání `DocumentContent`, protože mapovací tabulka neobsahovala `FileId`, což komplikovalo rollback při chybě FTS.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L96-L154】
