# Analýza indexace, vyhledávání a filtrace

> **Poznámka:** Funkce fuzzy vyhledávání a trigramové fallbacky byly z aplikace odstraněny. Dokument popisuje původní architekturu a je zachován pro historickou referenci.

Tento dokument shrnuje, jak Veriado promítá soubory do fulltextových struktur SQLite, jak vyhodnocuje dotazy (včetně fuzzy fallbacku) a jak nad výsledky aplikuje filtry mřížky.

## Přehled architektury
- **Doménová vrstva.** `FileEntity` při změně stavu proměňuje agregát na `SearchDocument`, který obsahuje normalizovaný titul, MIME typ, autora, souhrn metadat a serializovaný JSON. `MetadataTextFormatter` generuje souhrn z lidsky čitelných atributů, aby bylo k dispozici kvalitní zvýraznění výsledků.【F:Veriado.Domain/Files/FileEntity.cs†L365-L405】【F:Veriado.Domain/Search/SearchDocument.cs†L11-L98】【F:Veriado.Domain/Search/MetadataTextFormatter.cs†L12-L104】
- **Koordinace zápisu.** `SqliteSearchIndexCoordinator` rozhoduje, zda se indexace provede synchronně (`SameTransaction`) nebo asynchronně přes `SqliteFts5Indexer`. Obě cesty využívají `SqliteFts5Transactional`, který manipuluje FTS i trigram tabulkami ve sdílené transakci SQLite a zapisuje do žurnálu odolného vůči pádu.【F:Veriado.Infrastructure/Search/SqliteSearchIndexCoordinator.cs†L9-L74】【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L16-L88】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L10-L206】
- **Konfigurace.** `SearchOptions` a `SearchScoreOptions` poskytují výchozí váhy pro `bm25`, parametry trigramů i volbu profilů analyzéru. Registrace probíhá přes `ServiceCollectionExtensions`, takže všechny služby dostanou odpovídající `IOptions<T>`.【F:Veriado.Application/Search/SearchOptions.cs†L7-L71】【F:Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs†L93-L123】

## Indexační pipeline
1. **Mapování identifikátorů.** `SqliteFts5Transactional.IndexAsync` zajišťuje vazby mezi GUID souboru a `rowid` v tabulkách `file_search_map` a `file_trgm_map`. Oddělení logických klíčů od interních `rowid` zjednodušuje reindexaci a mazání.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L28-L220】
2. **Zápis do FTS5.** Metoda vloží „delete“ marker pro odstranění starého obsahu a následně zapíše normalizovaný titul, MIME, autora, `metadata_text` a JSON `metadata` do tabulky `file_search`. Tokenizer `unicode61` je nakonfigurován bez diakritiky, takže vyhledávání funguje i při zadání bez háčků a čárek.【F:Veriado.Infrastructure/Persistence/Schema/Fts5.sql†L1-L30】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L61-L103】
3. **Generování trigramů.** Při indexaci se vybrané segmenty (titul, autor, název souboru, metadata_text) poskládají pomocí `TrigramQueryBuilder.BuildIndexEntry`. Proces respektuje limit 2 048 tokenů, aby trigram tabulka nerostla neúměrně u extrémně dlouhých dokumentů.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L33-L156】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L82-L102】
4. **Asynchronní úkoly.** Pokud indexace běží mimo transakci Entity Frameworku, `SqliteFts5Indexer` otevírá vlastní připojení a serializuje práci pomocí `AsyncLock`, aby se předešlo kolizím nad FTS tabulkami. Po úspěchu se žurnálové záznamy vyčistí.【F:Veriado.Infrastructure/Search/SqliteFts5Indexer.cs†L16-L88】【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L105-L206】

## Vyhodnocování dotazů
- **Sestavení dotazu.** `SearchQueryBuilder` kombinuje boolovské, frázové, proximní, rozsahové i prefixové operátory. Při kompilaci dotazu se uplatní synonyma a profil analyzéru, výsledkem je `SearchQueryPlan` určující i potřebu trigramového fallbacku.【F:Veriado.Application/Search/SearchQueryBuilder.cs†L11-L220】【F:Veriado.Application/Search/SearchQueryPlan.cs†L1-L76】
- **Hybridní strategie.** `HybridSearchQueryService` dle plánu spouští FTS dotaz (`SqliteFts5QueryService`) a případně trigramovou aproximaci. Výsledky se kombinují pomocí normalizovaných skóre a konfigurovatelných vah (`OversampleMultiplier`, `TrigramFloor`).【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L7-L197】【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L19-L229】
- **Řazení a zvýraznění.** `SqliteFts5QueryService` počítá `bm25` s váhami 4.0 (titul), 2.0 (autor), 0.8 (`metadata_text`), 0.2 (`metadata`) a 0.1 (MIME). Fragmenty vytváří přes `snippet` a pro starší indexy nabízí fallback do JSON metadat. Do sort klíčů ukládá i normalizované skóre a `LastModifiedUtc` pro následné slučování s trigramy.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L70-L229】
- **Fuzzy vyhledávání.** Pokud dotaz obsahuje překlep nebo explicitně požaduje fuzzy režim, trigramový index vrátí kandidáty podle Jaccardovy podobnosti. `HybridSearchQueryService` je normalizuje, aplikuje minimální práh a slučuje s výsledky FTS, přičemž upřednostňuje vyšší skóre a novější záznamy.【F:Veriado.Application/Search/TrigramQueryBuilder.cs†L79-L156】【F:Veriado.Infrastructure/Search/HybridSearchQueryService.cs†L82-L197】

## Filtrace výsledků mřížky
- **Získání kandidátů.** `FileGridQueryHandler` skládá fulltextový plán, dotáže se na kandidátní `Guid` se skóre a následně omezí množinu pouze na soubory, které projdou relační filtrací. Preferovaná strategie (FTS vs. trigram) vychází z preferencí dotazu nebo uložené oblíbené položky.【F:Veriado.Application/UseCases/Queries/FileGrid/FileGridQueryHandler.cs†L24-L210】
- **Relační filtry.** `QueryableFilters.ApplyFilters` aplikuje na `IQueryable<FileEntity>` desítky parametrů – textové shody přes `LIKE`, hodnoty velikosti, časová okna, platnost dokumentu či stav indexace. Logika využívá `DateOnly` pro „dnes“ a čistě transponuje DTO na SQL, aby zůstalo možné využít indexy databáze.【F:Veriado.Application/UseCases/Queries/FileGrid/QueryableFilters.cs†L13-L213】【F:Veriado.Contracts/Files/FileGridQueryDto.cs†L7-L108】
- **Řazení a stránkování.** Po aplikaci filtrů služba buď zachová pořadí podle skóre z fulltextu (pokud je primární sort `score`), nebo použije pomocný sort nad sloupci databáze (jméno, MIME, datum, platnost). `QueryableFilters.ApplyOrdering` zajišťuje deterministické pořadí doplněním `ThenBy(file => file.Id)`.【F:Veriado.Application/UseCases/Queries/FileGrid/FileGridQueryHandler.cs†L102-L210】【F:Veriado.Application/UseCases/Queries/FileGrid/QueryableFilters.cs†L139-L188】
- **Historie a skóre.** Handler zapisuje průběžnou historii (`ISearchHistoryService`) a propisuje skóre zpět do DTO, aby klientská mřížka zobrazila hodnotu relevance. Pokud fuzzy režim nenajde žádný průnik, vrací se prázdný výsledek a historie se označí jako fuzzy dotaz.【F:Veriado.Application/UseCases/Queries/FileGrid/FileGridQueryHandler.cs†L52-L210】

## Údržba a kvalita indexu
- **Suggestion a spelling.** `SuggestionMaintenanceService` během indexace sklízí tokeny pro tabulku `suggestions`, která napájí autocomplete i kontrolu pravopisu. Stejná data slouží jako slovník pro trigramový spellchecker.【F:Veriado.Infrastructure/Search/SuggestionMaintenanceService.cs†L13-L176】
- **Synonyma.** Tabulka `synonyms` umožňuje mapovat varianty termínů. `SearchQueryBuilder` při kompilaci automaticky rozšíří dotaz o zadané varianty, což zlepšuje vyhledání relevantních dokumentů i při odlišné terminologii.【F:Veriado.Infrastructure/Search/SqliteFts5QueryService.cs†L170-L321】【F:Veriado.Application/Search/SearchQueryBuilder.cs†L120-L266】
- **Odolnost vůči chybám.** Každá operace indexace zachytává chyby `SqliteException`, které indikují poškození nebo chybějící schéma. V takovém případě se vyhodí `SearchIndexCorruptedException`, což umožňuje aplikaci vyvolat proces oprav nebo reindexace. Žurnál `FtsWriteAheadService` navíc drží změny, dokud nedojde ke commit-u transakce.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L47-L206】【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L13-L210】
- **Možnosti konfigurace.** Administrátor může upravit počet trigramů, váhy skórování či výchozí jazyk analyzéru v `appsettings.json`. Tím lze vybalancovat výkon mezi přesným a fuzzy vyhledáváním pro konkrétní dataset.【F:Veriado.Application/Search/SearchOptions.cs†L7-L71】

## Doporučení pro další rozvoj
1. **Enrichment metadat.** Doplnění překladů SID → jméno uživatele a lokalizace atributů by zvýšilo kvalitu `metadata_text`, a tím i relevance snippetů.【F:Veriado.Domain/Search/MetadataTextFormatter.cs†L12-L104】
2. **Telemetry indexace.** Sběr metrik (počet tokenů, velikost trigram tabulky, čas indexace) by umožnil sledovat efekt limitu 2 048 trigramů a včas reagovat na anomálie.
3. **Incrementální reindexace.** Aktuální pipeline vyžaduje úplné přepsání řádků. Zavedení fronty pro přírůstkovou aktualizaci trigramů by mohlo zrychlit indexaci velkých dokumentů.
4. **Lepší fallback pro JSON metadata.** Uživatelé využívající staré indexy by ocenili, kdyby se JSON pole transformovalo do čitelnějších párů `key:value` během snippetů, místo syrového JSON.
