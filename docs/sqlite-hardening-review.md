# Audit SQLite-only řešení

## Shrnutí
- Aplikační vrstva přistupuje k SQLite výhradně přes tranzakce EF Core, které jsou vynuceně typu `SqliteTransaction`, takže zápisy relační databáze a FTS5 indexu probíhají atomicky a v případě selhání se celý batch vrací zpět.【F:Veriado.Infrastructure/Concurrency/WriteWorker.cs†L235-L335】【F:Veriado.Infrastructure/Concurrency/WriteWorker.cs†L379-L471】
- Fulltextové operace využívají vlastní write-ahead žurnál (`fts_write_ahead`) a převádí chyby `SqliteException` na `SearchIndexCorruptedException`, což umožňuje automatický rebuild i přes transientní chyby.【F:Veriado.Infrastructure/Search/SqliteFts5Transactional.cs†L17-L120】【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L18-L129】
- Startup pipeline vždy aplikuje PRAGMA nastavení, rehydruje WAL režim, přehrává žurnál a spouští konzistenci fulltextu včetně automatické opravy; přítomné jsou též pravidelné VACUUM/PRAGMA optimize úlohy.【F:Veriado.Infrastructure/Persistence/SqlitePragmaHelper.cs†L11-L78】【F:Veriado.Infrastructure/Integrity/StartupIntegrityCheck.cs†L12-L54】【F:Veriado.Infrastructure/Maintenance/SqliteDatabaseMaintenanceService.cs†L9-L36】
- Indexový auditor kombinuje hash podpisy obsahu a názvů pro detekci driftu a je propojen se zápisovým workerem; tím se zajišťuje, že změna analyzéru nebo obsahových hashů vede ke znovuindexaci.【F:Veriado.Infrastructure/Search/NeedsReindexEvaluator.cs†L5-L24】【F:Veriado.Infrastructure/Concurrency/WriteWorker.cs†L288-L324】【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L11-L100】

## Identifikované slabiny
1. **Absence plánovače pro IndexAuditor** – Auditing driftu je implementován, ale ve službách není žádný hosted service, který by jej pravidelně spouštěl. V praxi to znamená závislost na manuálním startu, takže potenciální nesoulad může přetrvat, dokud administrátor audit ručně nespustí.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L11-L121】【F:Veriado.Infrastructure/DependencyInjection/ServiceCollectionExtensions.cs†L136-L201】
2. **Write-ahead DLQ není monitorován** – Neexistuje automatické vyprazdňování tabulky `fts_write_ahead_dlq` ani health check, který by alarmoval na rostoucí backlog. Při opakujících se selháních by tak problém mohl zůstat skrytý, přestože infrastruktura zapisuje do dead-letter tabulky.【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L93-L204】【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L240-L312】
3. **Manuální zásahy do PRAGMA** – Helper nastaví `journal_mode=WAL`, `synchronous=NORMAL` a další volby při každém otevření, ale chybí verifikace po spuštění (např. jestli externí skript nezměnil hodnoty). Monitoring by měl pravidelně kontrolovat `PRAGMA journal_mode` a `busy_timeout`, jinak se sníží odolnost vůči výpadkům.【F:Veriado.Infrastructure/Persistence/SqlitePragmaHelper.cs†L23-L77】
4. **Obnova spoléhá na single-thread rebuild** – Metoda `RepairAsync` provádí rebuild sekvenčně přes EF Core a sdílený kontext. U větších datasetů by to mohlo blokovat write worker na dlouhou dobu; není zde mechanika pro inkrementální rebuild nebo přepnutí na záložní DB, což snižuje dostupnost při katastrofickém selhání.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L94-L212】

## Doporučení pro další zrobustnění
- **Naplánovat periodický audit** – Přidat hosted službu, která jednou denně spustí `IndexAuditor.VerifyAsync`, publikuje telemetry (`RecordIndexDrift`) a pokud jsou nalezeny odchylky, automaticky enqueue reindex. Zároveň odeslat health check signál do observability stacku.【F:Veriado.Infrastructure/Integrity/IndexAuditor.cs†L57-L118】
- **Monitorovat DLQ** – Vytvořit diagnostickou end-point nebo metrický čítač pro počet záznamů v `fts_write_ahead_dlq` a upozornění, pokud backlog narůstá. Případně doplnit background worker, který se pokusí záznamy znovu zpracovat po fixu chyby.【F:Veriado.Infrastructure/Search/FtsWriteAheadService.cs†L200-L312】
- **Ověřovat PRAGMA stav** – Do integrity auditu přidat kontrolu, která čte `PRAGMA journal_mode`, `PRAGMA synchronous` a `PRAGMA busy_timeout` a porovnává je s očekávanými hodnotami; odchylka by měla vyvolat log/alert a volitelně automaticky opravovat.【F:Veriado.Infrastructure/Persistence/SqlitePragmaHelper.cs†L25-L77】
- **Zrychlit rebuild** – Zvážit paralelní `RepairAsync` (např. dávkování přes `Task.WhenAll` s limitem) nebo offline rebuild (např. rebuild do dočasné DB a atomická výměna souboru). Tak lze zkrátit dobu výpadku a snížit tlak na `WriteWorker`.【F:Veriado.Infrastructure/Integrity/FulltextIntegrityService.cs†L154-L229】

Celkově je SQLite-only řešení solidně chráněno proti běžným selháním (transakční konzistence, retry, write-ahead, automatická oprava). Pro provoz v náročnějším prostředí však doporučujeme doplnit plánované audity, monitoring dead-letter fronty, kontinuální validaci PRAGMA nastavení a efektivnější rebuild strategie, aby infrastruktura lépe odolala dlouhodobým nebo opakovaným incidentům.
